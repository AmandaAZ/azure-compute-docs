---
title: Deploy Azure Log Analytics for Cloud Foundry | Microsoft Docs
description: How to deploy Azure Log Analytics tool and use it to monitor the Cloud Foundry system health and performance metrics
services: virtual-machines-linux
documentationcenter: ''
author: ningk
manager: timlt
editor: ''
tags:
keywords: ''

ms.assetid: ?
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure-services
ms.date: 07/22/2017
ms.author: ningk
---

# Background

[Azure Log Analytics](https://azure.microsoft.com/en-us/services/log-analytics/) is a service in Microsoft [Operations Management Suite](https://docs.microsoft.com/en-us/azure/operations-management-suite/) (OMS) that helps you collect and analyze data generated by resources in your cloud and on-premises environments.

The Microsoft Azure Log Analytics Nozzle is a Cloud Foundry (CF) component which forwards metrics from the [Cloud Foundry Loggregator](https://docs.cloudfoundry.org/loggregator/architecture.html) Firehose to Azure Log Analytics. 

With Azure Log Analytics Nozzle (the Nozzle) release, you will be able to view, visualize, alert and take action with your Cloud Foundry health and performance metrics, across mulitple deployments. 

In this document, you will learn how to deploy the Nozzle to your Cloud Foundry environment, then access the data from the Azure Log Analytics OMS console.

# Prerequisites
### 1. Deploy a CF or PCF environment in Azure
You can use Azure Log Analytics Nozzle with either an open source Coud Foundry (CF) deployment or a Pivotal Cloud Foundry (PCF) deployment.

* [Deploy Cloud Foundry on Azure](https://github.com/cloudfoundry-incubator/bosh-azure-cpi-release/blob/master/docs/guidance.md)

* [Deploy Pivotal Cloud Foundry on Azure](https://docs.pivotal.io/pivotalcf/1-11/customizing/pcf_azure.html)

### 2. Install CF CLIs and UAA Command Line Client on your dev box
As many other CF tools, the nozzle runs as an application in CF environment, you need CF CLI to push the nozzle as an application. 
The nozzle also runs with a CF user who is authorized to access the loggregator firehose when transfering data, you need UAA command line client to create the user.

* [Install Cloud Foundry CLI](https://docs.cloudfoundry.org/cf-cli/install-go-cli.html)

* [Install Cloud Foundry UAA Command Line Client](https://github.com/cloudfoundry/cf-uaac/blob/master/README.md) 
Note you need to install Rubygems first to install UAA command Line Client.

### 3. Create an OMS Workspace in Azure
* Create the OMS workspace manually
You can create the OMS workspace manually, and load the pre-configured OMS views and alerts after you finished the nozzle deployment.
1.	In the Azure portal, search the list of services in the Marketplace for Log Analytics, and then select Log Analytics.
2.	Click Create, then select choices for the following items:
- OMS Workspace - Type a name for your workspace.
- Subscription - If you have multiple subscriptions, choose the same one with your CF deployment.
- Resource group - You can create a new resource group, or use the same one with your CF deployment.
- Location
- Pricing tier
Click OK to complete. 
For additional details, see [Get started with Log Analytics](https://docs.microsoft.com/en-us/azure/log-analytics/log-analytics-get-started)

* Create the OMS workspace through the OMS for CF template
You can create the OMS workspace, load the Pre-configured OMS views and alerts, all through the [OMS for CF template](TBD Link)

# Deploy 

### Deploy the Nozzle as a PCF Ops Manager tile
* If you've deployed PCF via Ops Manager, follow these steps to [Install and Configure Microsoft Azure Log Analytics Nozzle for PCF] (http://docs.pivotal.io/partners/azure-log-analytics-nozzle/installing.html), the nozzle will be installed as a tile with Ops manager.

### Deploy the Nozzle as an App to Cloud Foundry
* If you are not using PCF Ops Manager, you will need to push the nozzle as an application.
1. Login to your CF deployment as an admin through CF CLI
On your Dev box, run following command:
cf login -a https://api.${ENDPOINT} -u ${CF_USER} --skip-ssl-validation
```
To replace the ENDPOINT with your system domain, search the "system_domain" in your CF deployment manifest file. To replace the CF_USER with your CF admin user name, search the "scim" section, looking for the name and the "cf_admin_password" of in your CF deployment manifest file.
        

2. Create a CF user and grant required privileges
On your Dev box, run following command to create and configure the user to access loggregator firehose:
```
uaac target https://uaa.${ENDPOINT} --skip-ssl-validation
uaac token client get admin
cf create-user ${FIREHOSE_USER} ${FIREHOSE_USER_PASSWORD}
uaac member add cloud_controller.admin ${FIREHOSE_USER}
uaac member add doppler.firehose ${FIREHOSE_USER}
```
Note the ENDPOINT is the system domain of your CF deployment, see step 1 on how to retrive the path.You need provide the user name and password for the firehose user. 

3. Download the latest Azure Log Analytics Nozzle release
On your Dev box, run following command:
git clone https://github.com/Azure/oms-log-analytics-firehose-nozzle.git
cd oms-log-analytics-firehose-nozzle
```
4. Set environment variables in [manifest.yml](./manifest.yml)
This is the app manifest for the nozzle, you need to replace the value with your specific OMS workspace information.
OMS_WORKSPACE             : OMS workspace ID: open OMS portal from your OMS workspace, click "Settings", click "connected sources"
OMS_KEY                   : OMS key: open OMS portal from your OMS workspace, click "Settings", click "connected sources"
OMS_POST_TIMEOUT          : HTTP post timeout for sending events to OMS Log Analytics, default is 10s.
OMS_BATCH_TIME            : Interval for posting a batch to OMS Log Analytics, default is 10s.
OMS_MAX_MSG_NUM_PER_BATCH : The max number of messages in a batch to OMS Log Analytics, default is 1000.
API_ADDR                  : The api URL of the CF environment, refer to "Push the Nozzle as an App to Cloud Foundry" section step 1 on how to retrive your <CF_SYSTEM_DOMAIN>
DOPPLER_ADDR              : Loggregator's traffic controller URL, refer to "Push the Nozzle as an App to Cloud Foundry" section step 1 on how to retrive your <CF_SYSTEM_DOMAIN>
FIREHOSE_USER             : CF user you created in "Push the Nozzle as an App to Cloud Foundry" section, who has firehose access.
FIREHOSE_USER_PASSWORD    : Password of the CF user above.
EVENT_FILTER              : Event types to be filtered out. The format is a comma separated list, valid event types are METRIC,LOG,HTTP
SKIP_SSL_VALIDATION       : If true, allows insecure connections to the UAA and the Trafficcontroller
CF_ENVIRONMENT            : Enter any string value for identifying logs and metrics from different CF environments
IDLE_TIMEOUT              : Keep Alive duration for the firehose consumer, default is 60s.
LOG_LEVEL                 : Logging level of the nozzle, valid levels: DEBUG, INFO, ERROR
LOG_EVENT_COUNT           : If true, the total count of events that the nozzle has received and sent will be logged to OMS Log Analytics as CounterEvents
LOG_EVENT_COUNT_INTERVAL  : The time interval of logging event count to OMS Log Analytics, default is 60s.

### Push the app from your dev box
Make sure you are under the folder "oms-log-analytics-firehose-nozzle", run:
cf push

# Validate the nozzle installation
### From Apps Manager (For PCF)
1. Log in to Apps Manager
2. Browse to the space where you have created for the nozzle, check the status of the application.

### From Dev Box
On you Dev box CF CLI window, type:
```
cf apps
```
Make sure the OMS nozzle application is running.

# View the data in OMS Portal
* If you did not use the OMS for CF template, you will need to manually import the default views and create the alerts.

### 1. Import OMS View
From the OMS portal, browse to **View Designer** -> **Import** -> **Browse**, select one of the omsview files, e.g. Cloud Foundry.omsview, and save the view. Now a **Tile** will be displayed on the main OMS Overview page. Click the **Tile**, it will show visualized metrics.

Operators could customize these views or create new views through **View Designer**.

> Please note the "Cloud Foundry.omsview" is a preview version of Cloud Foundry OMS view template, a fully configured default template is in progress, please send your suggestions and feedback to the [Issue Section](https://github.com/Azure/oms-log-analytics-firehose-nozzle/issues).

### 2. <a name="alert">Create Alert rules</a>
For the process of creating alert rules in OMS Log Analytics, please refer to this [
    article](https://docs.microsoft.com/en-us/azure/log-analytics/log-analytics-alerts).

Operators could customize the queries and threshold values as needed. Below are a set of recommended alerts.


| Search query                                                                  | Generate alert based on | Description                                                                       |
| ----------------------------------------------------------------------------- | ----------------------- | --------------------------------------------------------------------------------- |
| Type=CF_ValueMetric_CL Origin_s=bbs Name_s="Domain.cf-apps"                   | Number of results < 1   | **bbs.Domain.cf-apps** indicates if the cf-apps Domain is up-to-date, meaning that CF App requests from Cloud Controller are synchronized to bbs.LRPsDesired (Diego-desired AIs) for execution. No data received means cf-apps Domain is not up-to-date in the given time window. |
| Type=CF_ValueMetric_CL Origin_s=rep Name_s=UnhealthyCell Value_d>1            | Number of results > 0   | For Diego cells, 0 means healthy, and 1 means unhealthy. Set the alert if multiple **unhealthy Diego cells** are detected in the given time window. |
| Type=CF_ValueMetric_CL Origin_s="bosh-hm-forwarder" Name_s="system.healthy" Value_d=0 | Number of results > 0 | 1 means the system is healthy, and 0 means the system is not healthy. |
| Type=CF_ValueMetric_CL Origin_s=route_emitter Name_s=ConsulDownMode Value_d>0 | Number of results > 0   | Consul emits its health status periodically. 0 means the system is healthy, and 1 means that route emitter detects that **Consul is down**. |
| Type=CF_CounterEvent_CL Origin_s=DopplerServer (Name_s="TruncatingBuffer.DroppedMessages" or Name_s="doppler.shedEnvelopes") Delta_d>0 | Number of results > 0 | The delta number of messages intentionally **dropped** by Doppler due to back pressure. |
| Type=CF_LogMessage_CL SourceType_s=LGR MessageType_s=ERR                      | Number of results > 0   | Loggregator emits **LGR** to indicate problems with the logging process, e.g. when log message output is too high. |
| Type=CF_ValueMetric_CL Name_s=slowConsumerAlert                               | Number of results > 0   | When the nozzle receives slow consumer alert from Loggregator, it sends **slowConsumerAlert** ValueMetric to OMS. |
| Type=CF_CounterEvent_CL Job_s=nozzle Name_s=eventsLost Delta_d>0              | Number of results > 0   | If the delta number of **lost events** reaches a threshold, it means the nozzle might have some problem running. |


# Scaling the Nozzle
### 1. Scaling Nozzle
We recommend operators to start with at least two instances of the nozzle. The firehose will distribute the workload across all instances of the nozzle. 
To make sure the nozzle can keep up with the data traffic from the firehose, the operator should setup the **slowConsumerAlert** alert listed in the "Create Alert Rules" section; once alerted, follow the [guidacne for slow nozzle] (https://docs.pivotal.io/pivotalcf/1-11/loggregator/log-ops-guide.html#slow-noz) to determine whether scaling is needed. 
To scale up the nozzle, use Apps Manager or the CF CLI to increase the instance numbers or memory/disk resources for the nozzle.

### 2. Scaling Loggregator
Loggregator sends **LGR** log message to indicate problems with the logging process. The operator can monitor the alert to determine whether the loggregator needs to be scaled up.
To scale up the loggregator, the operator can either increase Doppler buffer size or add additional Doppler server instances in the CF manifest, for details, check [the guidance for scaling the Loggregator](https://docs.cloudfoundry.org/running/managing-cf/logging-config.html#scaling).


# Remove the Nozzle from your Cloud Foundry deployment
### 1. From Apps Manager
1. Log in to Apps Manager
2. Browse to the space and then the nozzle application 
3. Click "Settings", choose "Delete App"

### 2. From Dev Box
On your CF CLI window, type:
```
cf delete <App Name> -r
```
###Note if you remove the nozzle, the data in OMS portal will not be automatically removed, however it will expire based on your retention policy.

## Support and Feedback
- Azure Analytics Nozzle for Cloud Foundry is open sourced, feel free to send your questions and comments to the [github issue section] (https://github.com/Azure/oms-log-analytics-firehose-nozzle/issues). 

- To open Azure support request, use the "Virtual Machine running Cloud Foundry" as the service category. 

# Next step:
- In addition to the Cloud Foundry metrics data that are covered in the nozzle, you can utilize OMS agent to gain insights to the VM level operational data (Syslog, Performance, Alerts, Inventory), it will be installed as a Bosh Addon to your CF VMs.
- See  [Deploy OMS agent BOSH release to your Cloud Foundry deployment](https://github.com/Azure/oms-agent-for-linux-boshrelease) for details. 