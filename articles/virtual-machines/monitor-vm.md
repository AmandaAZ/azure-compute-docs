---
title: Monitoring Azure virtual machines
description: Start here to learn how to monitor Azure virtual machines
ms.service: container-service
ms.topic: article
ms.custom: subject-monitoring
ms.date: 06/21/2021
---

# Monitoring Azure virtual machines

When you have critical applications and business processes relying on Azure resources, you want to monitor those resources for their availability, performance, and operation. This article describes the monitoring data generated by Azure virtual machines and how you can use the features of [Azure Monitor](/azure/azure-monitor/overview) to analyze and alert on this data.


## What is Azure Monitor?
[Azure Monitor](/azure/azure-monitor/overview) is a full stack monitoring service that provides a complete set of features to monitor your Azure resources. You don't need to directly interact with Azure Monitor though to perform a variety of monitoring tasks since its features are integrated into the Azure portal for Azure services that it monitors. If you're interested in a general overview of how Azure Monitor works with Azure resources, see [Monitoring Azure resources with Azure Monitor](../azure-monitor/essentials/monitor-azure-resource.md).

## Collect guest metrics
Azure Monitor starts collecting metric data for your virtual machine host automatically. To collect metrics from the guest operating system of the virtual machine though, you must install an agent that can send this data to Azure Monitor. The [Diagnostic extension](../azure-monitor/agents/diagnostics-extension-overview.md) is the classic agent used to collect guest metrics from Azure virtual machines. You can configure it directly from the virtual machine's menu in the Azure portal. The diagnostic extension does require that metric data also be sent to an Azure storage account.

> [!NOTE]
> Azure Monitor agent is intended to replace diagnostic extension to collect guest metrics. While the agent is generally available, metric collection is currently still in preview. When this feature is generally available, this content will be updated to use Azure Monitor agent instead of diagnostic extension.

### Windows virtual machines
Use the following procedure to install the diagnostic extension and enable guest metric collection on a Windows virtual machine.

1. From the virtual machine's menu in the Azure portal, select **Diagnostic settings**. Select a storage account and click **Enable guest-level monitoring**.

:::image type="content" source="media/monitor-vm/diagnostic-extension-windows-enable.png" lightbox="media/monitor-vm/diagnostic-extension-windows-enable.png" alt-text="Enable guest monitoring for Windows virtual machine":::

2. Select **Performance counters** and select the categories that you want to collect. Select **Custom** if you want to select individual counters or change the sample rate.

:::image type="content" source="media/monitor-vm/diagnostic-extension-windows-counters.png" lightbox="media/monitor-vm/diagnostic-extension-windows-counters.png" alt-text="Select performance counters for Windows virtual machine":::



## Analyze virtual machine metrics

### Overview page
The **Overview** page in the Azure portal for each virtual machine includes charts that provide common usage metrics such as average CPU and network utilization. Click on any of these charts to open up metrics explorer to drill down further or to analyze them with additional metrics.

:::image type="content" source="media/monitor-vm/overview.png" lightbox="media/monitor-vm/overview.png" alt-text="Azure virtual machine overview page":::

### Metrics explorer

[!INCLUDE [View metrics](../../includes/azure-monitor-horizontal-view-metrics.md)]



## Metric namespaces and values

| Namespace | Description |
|:---|:---|
| 

## VM insights
Some services in Azure have a customized monitoring experience in Azure Monitor that includes pre-built workbooks and other specialized features for that particular service. These experiences are called *insights*. VM insights provides features such as the following:

- Easily deploy the agents required to collect data from the guest operating system of virtual machines.
- Pre-built workbooks to analyze the performance and availability of each virtual machine.
- View processes running on individual virtual machines and dependencies between them.

See [Enable Azure Monitor for single virtual machine or virtual machine scale set in the Azure portal](../azure-monitor/vm/vminsights-enable-portal.md) for quick steps to configure VM insights and enable monitoring for a virtual machine. See [Enable VM insights overview](../azure-monitor/vm/vminsights-enable-overview.md) for general information on enabling insights and different methods for onboarding virtual machines.

## Monitoring data

Azure virtual machines collect the same kinds of monitoring data as other Azure resources that are described in [Monitoring data from Azure resources](/azure/azure-monitor/insights/monitor-azure-resource#monitoring-data-from-Azure-resources). AKS provides a set of metrics for the control plane, including the API Server and cluster autoscaler, and cluster nodes. These metrics allow you to monitor the health of your cluster and troubleshoot issues. You can view the metrics for your cluster using the Azure portal.


See [Monitoring *AKS* data reference](monitor-aks-reference.md) for detailed information on the metrics and logs metrics created by AKS.

AKS also provides additional resource logging data, such as [control plane component logs](view-control-plane-logs.md), [kubelet logs](kubelet-logs.md), and [real-time container data](/azure/azure-monitor/containers/container-insights-livedata-overview.md).




## Analyzing logs

Data in Azure Monitor Logs is stored in tables where each table has its own set of unique properties.  

All resource logs in Azure Monitor have the same fields followed by service-specific fields. The common schema is outlined in [Azure Monitor resource log schema](/azure/azure-monitor/platform/diagnostic-logs-schema#top-level-resource-logs-schema) The schema for AKS resource logs is found in the [AKS Data Reference](monitor-aks-reference.md#schemas).

The [Activity log](/azure/azure-monitor/platform/activity-log) is a type of platform log in Azure that provides insight into subscription-level events. You can view it independently or route it to Azure Monitor Logs, where you can do much more complex queries using Log Analytics.  

For a list of the types of resource logs collected for AKS, see [Monitoring AKS data reference](monitor-aks-reference.md#resource-logs)  

For a list of the tables used by Azure Monitor Logs and queryable by Log Analytics, see [Monitoring AKS data reference](monitor-aks-reference.md##azure-monitor-logs-tables).

### Sample Kusto queries

> [!IMPORTANT]
> When you select **Logs** from the AKS menu, Log Analytics is opened with the query scope set to the current AKS. This means that log queries will only include data from that resource. If you want to run a query that includes data from other clusters or data from other Azure services, select **Logs** from the **Azure Monitor** menu. See [Log query scope and time range in Azure Monitor Log Analytics](/azure/azure-monitor/log-query/scope/) for details.

Following is an [example query to list all container images and their status](https://github.com/microsoft/AzureMonitorCommunity/blob/master/Azure%20Services/Kubernetes%20services/Queries/Diagnostics/Image%20inventory.kql).

```Kusto
ContainerImageInventory
| summarize AggregatedValue = count() by Image, ImageTag, Running, _ResourceId
```

For a full list of example queries, see the [AKS Queries section in the AzureMonitorCommunity GitHub repo](https://github.com/microsoft/AzureMonitorCommunity/tree/master/Azure%20Services/Kubernetes%20services/Queries). These examples are also available in the Azure portal.

## Alerts

Azure Monitor alerts proactively notify you when important conditions are found in your monitoring data. They allow you to identify and address issues in your system before your customers notice them. You can set alerts on [metrics](/azure/azure-monitor/platform/alerts-metric-overview), [logs](/azure/azure-monitor/platform/alerts-unified-log), and the [activity log](/azure/azure-monitor/platform/activity-log-alerts). Different types of alerts have benefits and drawbacks

The following table lists common and recommended alert rules for AKS.

| Rule Name | Condition | Description  |
|:---|:---|
| Completed job count | Number of completed jobs(more than 6 hours ago) are greater than 0 |
| Container CPU % | Average container CPU is greater than 95% |
| Container working set memory % | Average container working set memory is greater than 95% |
| Failed Pod counts | Number of Pods in Failed state are greater than 0 |
| Node CPU % | Average node CPU is greater than 80% |
| Node Disk Usage % | Average disk usage for a node is greater than 80% |
| Node NotReady status | Number of nodes in not ready state are greater than 0 |
| Node working set memory % | Average node working set memory is greater than 80% |
| OOM Killed Containers | Number of OOM killed containers are greater than  0 |
| Persistent Volume Usage % | Average PV usage is greater than 80% |
| Pods ready % | Average ready state pods are less than 80% |
| Restarting container count | Number of restarting containers are greater than 0 |

These alerts are also available as *Recommended alerts (Preview)* in the *Insights* area under *Monitoring* in the Azure portal.

## Next steps

- See [Monitoring AKS data reference](monitor-aks-reference.md) for a reference of the metrics, logs, and other important values created by AKS.
- See [Monitoring Azure resources with Azure Monitor](/azure/azure-monitor/insights/monitor-azure-resource) for details on monitoring Azure resources.
